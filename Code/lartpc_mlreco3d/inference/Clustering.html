
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Overview of CNN Based Clustering Models &#8212; lartpc_mlreco3d Tutorials</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
      <img src="../../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">lartpc_mlreco3d Tutorials</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../intro.html">
   Getting started
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Prerequisites
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../Prerequisites/Python-01-Jupyter.html">
   Using Jupyter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../Prerequisites/Python-02-Python.html">
   Introduction to Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../Prerequisites/Python-03-Numpy.html">
   Up and Running with Python3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../Prerequisites/Python-04-ScientificPython.html">
   Visualization, Fitting, and File Format
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../Prerequisites/Python-05-PyTorch.html">
   Pytorch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../Prerequisites/Python-06-MNIST-CIFAR10.html">
   Practice with MNIST
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../Prerequisites/Git.html">
   Version control with Git
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Some Physics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../Physics/Neutrinos.html">
   Neutrinos
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../Physics/Lartpc.html">
   Liquid Argon Time Projection Chamber (aka LArTPC)
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  lartpc_mlreco3d
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../README.html">
   Overview of the reconstruction chain
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../Data.html">
   Data I/O
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Data1.html">
     Using
     <code class="docutils literal notranslate">
      <span class="pre">
       lartpc_mlreco3d
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Data2.html">
     Using ROOT only
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../Output.html">
   Reconstruction outputs
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../UResNet_PPN.html">
     Semantics &amp; points of interest
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Clustering.html">
     Particle clustering
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Interaction.html">
     Interaction clustering, PID and primary particles
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Kinematics.html">
     Kinematics and particle hierarchy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Others.html">
     Others
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../Exercises/README.html">
   Exercises
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../Exercises/Michel_electron.html">
     Exercise 1: Finding Michel electrons
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../Exercises/dEdx.html">
     Exercise 2: muon dEdx
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../Exercises/Electron_gamma.html">
     Exercise 3: electron vs gamma separation
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Using SDF
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ComputeAccess/README.html">
   Set up your computing environment
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../../_sources/Code/lartpc_mlreco3d/inference/Clustering.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/DeepLearnPhysics/lartpc_mlreco3d_tutorials"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/DeepLearnPhysics/lartpc_mlreco3d_tutorials/issues/new?title=Issue%20on%20page%20%2FCode/lartpc_mlreco3d/inference/Clustering.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hyperspace-embedding-learning">
   1. Hyperspace Embedding Learning
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-single-layer-clustering-models-clustercnn-single-py">
     A. Single Layer Clustering Models (
     <code class="docutils literal notranslate">
      <span class="pre">
       clustercnn_single.py
      </span>
     </code>
     )
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#b-multi-layer-clustering-models-clusternet-py">
     B. Multi Layer Clustering Models (
     <code class="docutils literal notranslate">
      <span class="pre">
       clusternet.py
      </span>
     </code>
     )
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#proposal-free-mask-generators-pfmgs-or-gaussian-kernel-embedding-learning">
   2. Proposal-Free Mask Generators (PFMGs, or Gaussian Kernel Embedding Learning).
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="overview-of-cnn-based-clustering-models">
<h1>Overview of CNN Based Clustering Models<a class="headerlink" href="#overview-of-cnn-based-clustering-models" title="Permalink to this headline">¶</a></h1>
<p>All source code for CNN based clustering modules are included inside <code class="docutils literal notranslate"><span class="pre">cluster_cnn</span></code> directory under <code class="docutils literal notranslate"><span class="pre">mlreco.models</span></code>. Some backbone network architectures are included in <code class="docutils literal notranslate"><span class="pre">mlreco.models.layers</span></code>; for example, <code class="docutils literal notranslate"><span class="pre">uresnet.py</span></code> and <code class="docutils literal notranslate"><span class="pre">fpn.py</span></code>.</p>
<div class="section" id="hyperspace-embedding-learning">
<h2>1. Hyperspace Embedding Learning<a class="headerlink" href="#hyperspace-embedding-learning" title="Permalink to this headline">¶</a></h2>
<p>The first class of models use a convolutional neural network to learn a coordinate transform from the image space to a <span class="math notranslate nohighlight">\(d\)</span>-dimensional embedding feature space. For mathematical and architectural details, we refer to the documentation page.</p>
<div class="section" id="a-single-layer-clustering-models-clustercnn-single-py">
<h3>A. Single Layer Clustering Models (<code class="docutils literal notranslate"><span class="pre">clustercnn_single.py</span></code>)<a class="headerlink" href="#a-single-layer-clustering-models-clustercnn-single-py" title="Permalink to this headline">¶</a></h3>
<p>The single layer models may be trained via the <code class="docutils literal notranslate"><span class="pre">clustercnn_single.py</span></code> module inside <code class="docutils literal notranslate"><span class="pre">mlreco.models</span></code>. For these models, the clustering loss is applied only at the final layer. The <code class="docutils literal notranslate"><span class="pre">schema</span></code> for <code class="docutils literal notranslate"><span class="pre">iotools</span></code> is given as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">schema</span><span class="p">:</span>
        <span class="n">cluster_label</span><span class="p">:</span>
            <span class="o">-</span> <span class="n">parse_cluster3d_clean</span>
            <span class="o">-</span> <span class="n">cluster3d_mcst</span>
            <span class="o">-</span> <span class="n">sparse3d_fivetypes</span>
        <span class="n">input_data</span><span class="p">:</span>
            <span class="o">-</span> <span class="n">parse_sparse3d_scn</span>
            <span class="o">-</span> <span class="n">sparse3d_data</span>
        <span class="n">segment_label</span><span class="p">:</span>
            <span class="o">-</span> <span class="n">parse_sparse3d_scn</span>
            <span class="o">-</span> <span class="n">sparse3d_fivetypes</span>
</pre></div>
</div>
<p>The single layer models have the following options under <code class="docutils literal notranslate"><span class="pre">model.modules</span></code>. An example section of the training configuration file is included below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">clustercnn_single</span>
    <span class="n">modules</span><span class="p">:</span>
        <span class="n">network_base</span><span class="p">:</span>
            <span class="n">spatial_size</span><span class="p">:</span> <span class="mi">512</span>
            <span class="n">dimension</span><span class="p">:</span> <span class="mi">3</span>
        <span class="n">clustercnn_single</span><span class="p">:</span>
            <span class="n">coordConv</span><span class="p">:</span> <span class="kc">False</span>
            <span class="n">embedding_dim</span><span class="p">:</span> <span class="mi">2</span>
            <span class="n">filters</span><span class="p">:</span> <span class="mi">16</span>
            <span class="n">num_strides</span><span class="p">:</span> <span class="mi">5</span>
        <span class="n">clustering_loss</span><span class="p">:</span>
            <span class="n">intra_weight</span><span class="p">:</span> <span class="mf">1.0</span>
            <span class="n">inter_weight</span><span class="p">:</span> <span class="mf">1.0</span>
            <span class="n">inter_margin</span><span class="p">:</span> <span class="mf">1.5</span>
            <span class="n">intra_margin</span><span class="p">:</span> <span class="mf">0.5</span>
            <span class="n">reg_weight</span><span class="p">:</span> <span class="mf">0.001</span>
            <span class="n">norm</span><span class="p">:</span> <span class="mi">2</span>
    <span class="n">network_input</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">input_data</span>
    <span class="n">loss_input</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">segment_label</span>
        <span class="o">-</span> <span class="n">cluster_label</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">network_base</span></code>: An abstract base class for setting global parameters to the network. These include parameters such as:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">spatial_size</span></code> (default=512): The spatial size of the dataset. Currently <code class="docutils literal notranslate"><span class="pre">256</span></code>, <code class="docutils literal notranslate"><span class="pre">512</span></code>, and <code class="docutils literal notranslate"><span class="pre">768</span></code> are supported.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dimension</span></code> (default=3): Dimension of the dataset. Set to 2 for 2-dimensional sparse models and 3 for 3-dimensional sparse models.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nInputFeatures</span></code> (default=1): Number of input features to the network.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">leakiness</span></code> (default=0.0): Leakiness value for LeakyReLU activations.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">allow_bias</span></code> (default=False): Option to include bias terms in linear and convolutional layers.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">clustercnn_single</span></code>: Parameters for single layer loss clustering.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">coordConv</span></code>: Shorthand for “coordinate convolution” layers. If True, then the input coordinates are normalized to the range <span class="math notranslate nohighlight">\([-1, 1]\)</span> and concatenated to the feature tensor before the last linear layer.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">embedding_dim</span></code> (default=8): Dimension of the embedding hyperspace.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_filters</span></code> (default=16): Number of input filters, same as that of <code class="docutils literal notranslate"><span class="pre">UResNet</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_strides</span></code> (default=5): Number of downsamplings, same as that of <code class="docutils literal notranslate"><span class="pre">UResNet</span></code>.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">clustering_loss</span></code>: Configurations for clustering loss function.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">intra_weight</span></code>: Sets the weighting of the intra-cluster loss <span class="math notranslate nohighlight">\(w_{intra}\)</span>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">inter_weight</span></code>: Same for inter-cluster loss.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">intra_margin</span></code>: Sets the margin for intra-cluster loss <span class="math notranslate nohighlight">\(\delta_v\)</span>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">inter_margin</span></code>: Sets the margin for inter-cluster loss <span class="math notranslate nohighlight">\(\delta_d\)</span>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reg_weight</span></code>: Sets the weighting of the regularization loss <span class="math notranslate nohighlight">\(w_{reg}\)</span>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">norm</span></code>: The value of <span class="math notranslate nohighlight">\(p\)</span> for which <span class="math notranslate nohighlight">\(p\)</span>-norm to use. <span class="math notranslate nohighlight">\(p = 2\)</span> for euclidean norm.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="b-multi-layer-clustering-models-clusternet-py">
<h3>B. Multi Layer Clustering Models (<code class="docutils literal notranslate"><span class="pre">clusternet.py</span></code>)<a class="headerlink" href="#b-multi-layer-clustering-models-clusternet-py" title="Permalink to this headline">¶</a></h3>
<p>The multi-layer clustering modules contain most of the architectures for hyperspace embedding learning. For <code class="docutils literal notranslate"><span class="pre">iotools.schema</span></code>, use the following configurations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">schema</span><span class="p">:</span>
  <span class="n">cluster_label</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">parse_cluster3d_scales</span>
      <span class="o">-</span> <span class="n">cluster3d_mcst</span>
      <span class="o">-</span> <span class="n">sparse3d_fivetypes</span>
  <span class="n">input_data</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">parse_sparse3d_scn</span>
      <span class="o">-</span> <span class="n">sparse3d_data</span>
  <span class="n">segment_label</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">parse_sparse3d_scn_scales</span>
      <span class="o">-</span> <span class="n">sparse3d_fivetypes</span>
</pre></div>
</div>
<p>The parsers <code class="docutils literal notranslate"><span class="pre">parse_cluster3d_scales</span></code> and <code class="docutils literal notranslate"><span class="pre">parse_sparse3d_scn_scales</span></code> provide downsampled ground-truth informations to be used in the intermediate feature tensors along the decoding path. We first present an example of the training configuration and demonstrate each item:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="p">:</span> 
  <span class="n">name</span><span class="p">:</span> <span class="n">clusternet</span>
  <span class="n">modules</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">clusternet</span>
    <span class="n">network_base</span><span class="p">:</span>
      <span class="o">...</span>
    <span class="n">uresnet</span><span class="p">:</span>
      <span class="n">filters</span><span class="p">:</span> <span class="mi">16</span>
      <span class="n">num_strides</span><span class="p">:</span> <span class="mi">5</span>
    <span class="n">embeddings</span><span class="p">:</span>
      <span class="n">N</span><span class="p">:</span> <span class="mi">3</span>
      <span class="n">simple_conv</span><span class="p">:</span> <span class="kc">False</span>
      <span class="n">coordConv</span><span class="p">:</span> <span class="kc">True</span>
      <span class="n">num_filters</span><span class="p">:</span> <span class="mi">16</span>
      <span class="n">num_strides</span><span class="p">:</span> <span class="mi">5</span>
    <span class="n">clusternet</span><span class="p">:</span>
      <span class="n">backbone</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">uresnet</span>
      <span class="n">clustering</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">multi_stack</span>
        <span class="n">dist_N</span><span class="p">:</span> <span class="mi">3</span>
        <span class="n">dist_simple_conv</span><span class="p">:</span> <span class="kc">False</span>
        <span class="n">compute_distance_estimate</span><span class="p">:</span> <span class="kc">True</span>
    <span class="n">clustering_loss</span><span class="p">:</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">multi</span><span class="o">-</span><span class="n">distance</span>
      <span class="o">...</span>
      <span class="n">num_strides</span><span class="p">:</span> <span class="mi">5</span>
      <span class="n">norm</span><span class="p">:</span> <span class="mi">2</span>
      <span class="n">distance_estimate_weight</span><span class="p">:</span> <span class="mf">0.0</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">network_base</span></code>: Abstract base class for base network parameters, same as before.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uresnet</span></code>: Sets the parameters for uresnet, <strong>if <code class="docutils literal notranslate"><span class="pre">uresnet</span></code> is used under <code class="docutils literal notranslate"><span class="pre">clusternet.backbone</span></code></strong>. This is to allow different backbone architectures to share the same loss function. For available parameters under <code class="docutils literal notranslate"><span class="pre">uresnet</span></code>, see <code class="docutils literal notranslate"><span class="pre">mlreco.models.layers.uresnet</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">embeddings</span></code>: The current implementation “eats” a backbone architecture and attaches multiple layers in the decoding chain to produce hyperspace embeddings at each spatial scale.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">N</span></code>: Number of intermediate coordinate transform blocks.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">simple_conv</span></code>: If False, intermediate coordinate transform blocks are set to resnet-type blocks. If True, block units are replaced with simple BatchNormLeakyReLU + SubmanifoldConvolution blocks.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">embedding_dim</span></code>: Dimension of hyperspace embedding space at the final layer (where post-processing clustering algorithm is performed).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">coordConv</span></code>: If True, normalized coordinates are concatenated to the clustering features at each spatial scales.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">clusternet</span></code>: Higher level configurations pertaining to loss function structure and distance estimation maps.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">backbone</span></code>: Sets the backbone feature extracting network type. Currently <code class="docutils literal notranslate"><span class="pre">uresnet</span></code> and <code class="docutils literal notranslate"><span class="pre">fpn</span></code> are supported.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">clustering</span></code>: configurations for clustering subnetwork.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code>: Can choose between <code class="docutils literal notranslate"><span class="pre">multi</span></code>, <code class="docutils literal notranslate"><span class="pre">multi-fpn</span></code>, and <code class="docutils literal notranslate"><span class="pre">multi-stack</span></code>.</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">multi</span></code>: Default multi layer clustering module.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">multi-fpn</span></code>: Multi layer clustering using FPN backbone.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">multi-stack</span></code>: Multi layer clustering using stacked architecture backbone.</p></li>
</ol>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">dist_N</span></code>: Number of convolution blocks from final feature tensor to distance estimation map.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dist_simple_conv</span></code>: If True, distance estimation convolutions blocks are simple BNLeakyReLU + Submanifold Convolutions. If False, resnet-type blocks are used.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compute_distance_estimate</span></code>: If True, distance estimation branch is appended to the architecture.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">freeze_embeddings</span></code>: If True, all weights of the clustering network are freezed except for the distance estimation blocks.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">clustering_loss</span></code>: configurations for clustering loss function. Also shares <code class="docutils literal notranslate"><span class="pre">inter_weight</span></code>, <code class="docutils literal notranslate"><span class="pre">intra_margin</span></code>, etc., as before.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code>: Enhancement choices for clustering loss functions:</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">multi</span></code>: Vanilla multi layer clustering loss function. Embedding loss is applied at each spatial scale in the decoding path.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">multi-weighted</span></code>: Multi layer clustering loss with relative weightings.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">multi-repel</span></code>: Multi layer clustering with enemy repelling enhancement.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">multi-distance</span></code>: Multi layer clustering with distance estimation loss.</p></li>
</ol>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">distance_estimation_weight</span></code>: Weighting for distance estimation loss.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="proposal-free-mask-generators-pfmgs-or-gaussian-kernel-embedding-learning">
<h2>2. Proposal-Free Mask Generators (PFMGs, or Gaussian Kernel Embedding Learning).<a class="headerlink" href="#proposal-free-mask-generators-pfmgs-or-gaussian-kernel-embedding-learning" title="Permalink to this headline">¶</a></h2>
<p>The second class of models involve learning 3-dimensional embeddings that optimize the intersection over union of each instance mask.</p>
<p>Original paper: <a class="reference external" href="https://arxiv.org/abs/1906.11109">https://arxiv.org/abs/1906.11109</a></p>
<p>We modify the model implementation accordingly with sparse convolutions. All models are wrapped in <code class="docutils literal notranslate"><span class="pre">mlreco.models.clustercnn_se</span></code>. The “se” stands for <code class="docutils literal notranslate"><span class="pre">Spatial</span> <span class="pre">Embeddings</span></code>, which is the name used by the original authors of the paper.</p>
<p>Proposal-free mask generators all use the following <code class="docutils literal notranslate"><span class="pre">schema</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">schema</span><span class="p">:</span>
  <span class="n">cluster_label</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">parse_cluster3d_clean</span>
    <span class="o">-</span> <span class="n">cluster3d_mcst</span>
    <span class="o">-</span> <span class="n">sparse3d_fivetypes</span>
  <span class="n">input_data</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">parse_sparse3d_scn</span>
    <span class="o">-</span> <span class="n">sparse3d_data</span>
  <span class="n">segment_label</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">parse_sparse3d_scn</span>
    <span class="o">-</span> <span class="n">sparse3d_fivetypes</span>
</pre></div>
</div>
<p>Model configurations also follow similar conventions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="p">:</span> 
  <span class="n">name</span><span class="p">:</span> <span class="n">spatial_embeddings</span>
  <span class="n">modules</span><span class="p">:</span>
    <span class="n">network_base</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="n">spatial_embeddings</span><span class="p">:</span>
      <span class="n">seediness_dim</span><span class="p">:</span> <span class="mi">1</span>
      <span class="n">sigma_dim</span><span class="p">:</span> <span class="mi">1</span>
      <span class="n">embedding_dim</span><span class="p">:</span> <span class="mi">3</span>
    <span class="n">uresnet</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="n">clustering_loss</span><span class="p">:</span>
      <span class="n">seediness_weight</span><span class="p">:</span> <span class="mf">0.0</span>
      <span class="n">embedding_weight</span><span class="p">:</span> <span class="mf">10.0</span>
      <span class="n">smoothing_weight</span><span class="p">:</span> <span class="mf">1.0</span>
</pre></div>
</div>
<p>Note that the loss function configurations under <code class="docutils literal notranslate"><span class="pre">clustering_loss</span></code> are different from those of the hyperspace embedding models.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code>: This parameter configures the type of model to be used. Currently the following models are supported.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">spatial_embeddings</span></code>: Vanilla PFMG with offset vector regression and learnable center of attraction. (We will always work with learnable center of attractions).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">spatial_embeddings_stack</span></code>: PFMG with stacked backbone architecture. This model is likely to be deprecated and subject to change.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">spatial_embeddings_free</span></code>: PFMG with hyperspace embeddings learning. This “frees” the dependence on offset vector regression.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">spatial_embeddings</span></code>: PFMG specific configurations</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">seediness_dim</span></code>: Dimension of seediness map. Although this is configurable, it is unlikely to be set to anything other than 1.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sigma_dim</span></code>: Dimension of margin map. For spherical gaussian kernels, there is only one learnable margin per voxel, so it should be set to 1. For ellipsoidal models, set it equal to the number of dimension of the embedding space (which for 3D models is 3, unless using hyperspace version of PFMGs).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">embedding_dim</span></code>: Dimension of embedding space.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">clustering_loss</span></code>: Configurations for PFMG loss functions.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code>: Option for PFMG clustering loss variants. Currently the following loss fucntions are supported:</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">se_bce</span></code>: Applies Binary Cross Entropy loss to each generated mask.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">se_bce_ellipse</span></code>: BCE Loss for ellipsoidal kernel models.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">se_lovasz</span></code>: Applies Lovasz Hinge loss to each generated mask.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">se_lovasz_inter</span></code>: Lovasz Hinge loss with inter-cluster loss.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">se_lovasz_ellipse</span></code>: Lovasz Hinge loss + inter-cluster loss for ellipsoidal kernels.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">se_focal</span></code>: Applies Focal loss to each generated mask.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">se_weighted_focal</span></code>: Applies Focal loss with pixel-count based weightings.</p></li>
</ol>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">seediness_weight</span></code>: weighting for seediness loss.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">embedding_weight</span></code>: weighting for embedding loss.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">smoothing_weight</span></code>: weighting for smoothing loss.</p></li>
</ul>
</li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "DeepLearnPhysics/lartpc_mlreco3d_tutorials",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Code/lartpc_mlreco3d/inference"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By SLAC Neutrino Group<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>