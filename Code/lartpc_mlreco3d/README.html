
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>A Machine Learning Pipeline for LArTPC Data &#8212; lartpc_mlreco3d Tutorials</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">lartpc_mlreco3d Tutorials</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
   Getting started
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Prerequisites
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../Prerequisites/Python-01-Jupyter.html">
   Using Jupyter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../Prerequisites/Python-02-Python.html">
   Introduction to Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../Prerequisites/Python-03-Numpy.html">
   Up and Running with Python3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../Prerequisites/Python-04-ScientificPython.html">
   Visualization, Fitting, and File Format
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../Prerequisites/Python-05-PyTorch.html">
   Pytorch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../Prerequisites/Python-06-MNIST-CIFAR10.html">
   Practice with MNIST
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../Prerequisites/Git.html">
   Version control with Git
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Some Physics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../Physics/Neutrinos.html">
   Neutrinos
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../Physics/Lartpc.html">
   Liquid Argon Time Projection Chamber (aka LArTPC)
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  lartpc_mlreco3d
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../README.html">
   Overview of the reconstruction chain
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Data.html">
   Data I/O
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Data1.html">
     Using
     <code class="docutils literal notranslate">
      <span class="pre">
       lartpc_mlreco3d
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Data2.html">
     Using ROOT only
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Output.html">
   Reconstruction outputs
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../UResNet_PPN.html">
     Semantics &amp; points of interest
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Clustering.html">
     Particle clustering
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Interaction.html">
     Interaction clustering, PID and primary particles
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Kinematics.html">
     Kinematics and particle hierarchy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Others.html">
     Others
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../Exercises/README.html">
   Exercises
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Exercises/Michel_electron.html">
     Exercise 1: Finding Michel electrons
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Exercises/dEdx.html">
     Exercise 2: muon dEdx
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Exercises/Electron_gamma.html">
     Exercise 3: electron vs gamma separation
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Using SDF
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../ComputeAccess/README.html">
   Set up your computing environment
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/Code/lartpc_mlreco3d/README.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/DeepLearnPhysics/lartpc_mlreco3d_tutorials"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/DeepLearnPhysics/lartpc_mlreco3d_tutorials/issues/new?title=Issue%20on%20page%20%2FCode/lartpc_mlreco3d/README.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   A Machine Learning Pipeline for LArTPC Data
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#configuration-files">
   Configuration Files
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-a-configuration-file">
     Using A Configuration File
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reading-a-log">
   Reading a Log
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#recording-network-output">
     Recording network output
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#repository-structure">
   Repository Structure
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-a-new-model">
     Adding a new model
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#make-sure-you-can-load-data-you-need">
       1 - Make sure you can load data you need
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#include-your-model">
       2 - Include your model
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#documentation-todo">
       3 - Documentation TODO
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#iotools">
   Iotools
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#schema">
     1. Schema
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     2.
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#models">
   Models
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p><a class="reference external" href="https://travis-ci.com/DeepLearnPhysics/lartpc_mlreco3d"><img alt="Build Status" src="https://travis-ci.com/DeepLearnPhysics/lartpc_mlreco3d.svg?branch=develop" /></a></p>
<div class="section" id="a-machine-learning-pipeline-for-lartpc-data">
<h1>A Machine Learning Pipeline for LArTPC Data<a class="headerlink" href="#a-machine-learning-pipeline-for-lartpc-data" title="Permalink to this headline">¶</a></h1>
<p>This repository contains code used for training and running machine learning models on LArTPC data.</p>
<p>Basic example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># assume that lartpc_mlreco3d folder is on python path</span>
<span class="kn">from</span> <span class="nn">mlreco.main_funcs</span> <span class="kn">import</span> <span class="n">process_config</span><span class="p">,</span> <span class="n">train</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="c1"># Load configuration file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;lartpc_mlreco3d/config/test_uresnet.cfg&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">Loader</span><span class="p">)</span>
<span class="n">process_config</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<span class="c1"># train a model based on configuration</span>
<span class="n">train</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
</pre></div>
</div>
<p>For more details and to use the API, you can look at this <a class="reference external" href="http://stanford.edu/%7Eldomine/Demo.html">Jupyter notebook</a>.</p>
</div>
<div class="section" id="configuration-files">
<h1>Configuration Files<a class="headerlink" href="#configuration-files" title="Permalink to this headline">¶</a></h1>
<p>For your inspiration, the following are available in the <code class="docutils literal notranslate"><span class="pre">config</span></code> folder:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">test_chain_ppn.cfg</span></code> UResNet + PPN as two separate modules, can load separate weights for UResNet only.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">test_chain.cfg</span></code> Tests the chain UResNet + PPN + DBSCAN for clustering purposes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">test_uresnet_ppn.cfg</span></code> UResNet + PPN as a monolithic model.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">test_uresnet.cfg</span></code> UResNet alone.</p></li>
</ul>
<p>Typically in a configuration file you want to edit:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">batch_size</span></code> (in 2 places)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">weight_prefix</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log_dir</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">iterations</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">model_path</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">train</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gpus</span></code></p></li>
</ul>
<p>If you want more information stored, such as networ output tensors and post-processing outcomes, you can use <code class="docutils literal notranslate"><span class="pre">analysis</span></code> (scripts) and <code class="docutils literal notranslate"><span class="pre">outputs</span></code> (formatters)
to store them in CSV format and run your custom analysis scripts (see folder <code class="docutils literal notranslate"><span class="pre">analysis</span></code>).</p>
<p>TODO: describe configuration files in more detail</p>
<p>This section has described how to use the contents of this repository to train variations of what has already been implemented.  To add your own models and analysis, you will want to know how to contribute to the <code class="docutils literal notranslate"><span class="pre">mlreco</span></code> module.</p>
<div class="section" id="using-a-configuration-file">
<h2>Using A Configuration File<a class="headerlink" href="#using-a-configuration-file" title="Permalink to this headline">¶</a></h2>
<p>Most basic useage is to use the <code class="docutils literal notranslate"><span class="pre">run</span></code> script.  From the <code class="docutils literal notranslate"><span class="pre">lartpc_mlreco3d</span></code> folder:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>nohup python3 bin/run.py train_gnn.cfg &gt;&gt; log_gnn.txt <span class="p">&amp;</span>
</pre></div>
</div>
<p>This will train a GNN specified in <code class="docutils literal notranslate"><span class="pre">config/train_gnn.cfg</span></code>, save checkpoints and logs to specified directories in the <code class="docutils literal notranslate"><span class="pre">cfg</span></code>, and output <code class="docutils literal notranslate"><span class="pre">stderr</span></code> and <code class="docutils literal notranslate"><span class="pre">stdout</span></code> to <code class="docutils literal notranslate"><span class="pre">log_gnn.txt</span></code></p>
<p>You can generally load a configuration file into a python dictionary using</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yaml</span>
<span class="c1"># Load configuration file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;lartpc_mlreco3d/config/test_uresnet.cfg&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">Loader</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="reading-a-log">
<h1>Reading a Log<a class="headerlink" href="#reading-a-log" title="Permalink to this headline">¶</a></h1>
<p>A quick example of how to read a training log, and plot something</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;path/to/log.csv&#39;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

<span class="c1"># plot moving average of accuracy over 10 iterations</span>
<span class="n">df</span><span class="o">.</span><span class="n">accuracy</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;accuracy&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;iteration&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;moving average of accuracy&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># list all column names</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="recording-network-output">
<h2>Recording network output<a class="headerlink" href="#recording-network-output" title="Permalink to this headline">¶</a></h2>
<p><em>This is a new feature added Aug. 2019, whch made <code class="docutils literal notranslate"><span class="pre">analysis_keys</span></code> feature obsolete.</em></p>
<p><code class="docutils literal notranslate"><span class="pre">outputs</span></code> configuration block allows you to run scripts on input data and/or network outputs.
It also supports storing your scripts output in a CSV file for offline analysis.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">model</span><span class="p">:</span>
  <span class="nt">outputs</span><span class="p">:</span>
      <span class="nt">unwrapper</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">unwrapper_3d_scn</span>
      <span class="nt">parsers</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">uresnet_ppn</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">parsers</span></code> is the list of functions that consume input data and network outputs to perform some analysis. Here, we specified <code class="docutils literal notranslate"><span class="pre">uresnet_ppn</span></code> which is defined under <code class="docutils literal notranslate"><span class="pre">mlreco/output_formatters/uresnet_ppn.py</span></code>. You can implement your custom functions and make them available under <code class="docutils literal notranslate"><span class="pre">mlreco.output_formatters</span></code> module (see <code class="docutils literal notranslate"><span class="pre">mlreco/output_formatters/__init__.py</span></code>).</p>
<p><code class="docutils literal notranslate"><span class="pre">unwrapper</span></code> specifies a function that <em>unwrapps</em> the input data and network output. You can consider this as a pre-processing of data before calling <code class="docutils literal notranslate"><span class="pre">uresnet_ppn</span></code>. For instance, when we use <code class="docutils literal notranslate"><span class="pre">sparseconvnet</span></code> package, which is often done in this repository, multiple event tensors are combined into one torch tensor with <em>batch IDs</em>, which allows us to split the combined tensor into individual data element (e.g. an event). However, in the analysis stage, it is typical to run a function per event instead of many-events-combined single tensor. <code class="docutils literal notranslate"><span class="pre">unwrapper_3d_scn</span></code> (and there also exists <code class="docutils literal notranslate"><span class="pre">unwrapper_2d_scn</span></code>) unwrapps such tensors and make an array of data where each element corresponds to each data element (e.g. an event). <code class="docutils literal notranslate"><span class="pre">uresnet_ppn</span></code> can be written under such assumption and, therefore, in a simple manner (i.e. loop over events to apply analysis).</p>
<p>By default, both unwrapper and analysis functions are given the full input data and network outputs.
There are three additional (and optional) configuration options for the <code class="docutils literal notranslate"><span class="pre">outputs</span></code> section.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">model</span><span class="p">:</span>
  <span class="nt">outputs</span><span class="p">:</span>
    <span class="nt">unwrapper</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">unwrapper_3d_scn</span>
    <span class="nt">parsers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">uresnet_ppn</span>
    <span class="nt">data_keys</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">input_data</span>
    <span class="nt">output_keys</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">segmentation</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">points</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mask_ppn2</span>
    <span class="nt">main_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">input_data</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">data_keys</span></code> option specifies which key in the input data (to the network) should be processed.
The <code class="docutils literal notranslate"><span class="pre">output_keys</span></code> option specifies which key in the output data (from the network) should be processed.
They exist so that you may exclude some data that do not follow the format assumed by either an <code class="docutils literal notranslate"><span class="pre">unwrapper</span></code> or <code class="docutils literal notranslate"><span class="pre">parser</span></code> functions.
Finally, <code class="docutils literal notranslate"><span class="pre">main_key</span></code> can be used to specify which one of input data tensor should be used to group batch IDs.
Yes, that means <code class="docutils literal notranslate"><span class="pre">main_key</span></code> is a specific configuration for an unwrapper function, and probably the configuration key should be under unwrapper.
This is to be fixed in future.</p>
</div>
</div>
<div class="section" id="repository-structure">
<h1>Repository Structure<a class="headerlink" href="#repository-structure" title="Permalink to this headline">¶</a></h1>
<p>The ‘mlreco’ module contains several submodules:</p>
<ul class="simple">
<li><p>‘models’ - contains model definitions</p></li>
<li><p>‘iotools’ - contains parsers for <code class="docutils literal notranslate"><span class="pre">larcv</span></code> data as well as utilities used for sampling and turning data into batches</p></li>
<li><p>‘analysis’ - contains analysis scripts</p></li>
<li><p>‘output_formatters’ - writes model output for later analysis</p></li>
<li><p>‘visualization’ - several visualization tools for data</p></li>
<li><p>‘utils’ - a hodgepodge of functions used in a variety of places</p></li>
</ul>
<div class="section" id="adding-a-new-model">
<h2>Adding a new model<a class="headerlink" href="#adding-a-new-model" title="Permalink to this headline">¶</a></h2>
<p>Before you start contributing to the code, please see the <a class="reference internal" href="contributing.html"><span class="doc std std-doc">contribution guidelines</span></a>.</p>
<p>You may be able to re-use a fair amount of code, but here is what would be necessary to do everything from scratch:</p>
<div class="section" id="make-sure-you-can-load-data-you-need">
<h3>1 - Make sure you can load data you need<a class="headerlink" href="#make-sure-you-can-load-data-you-need" title="Permalink to this headline">¶</a></h3>
<p>Parsers already exist for a variety of sparse tensor outputs as well as particle outputs.</p>
<p>The most likely place you would need to add something is to <code class="docutils literal notranslate"><span class="pre">mlreco/iotools/parsers.py</span></code>.</p>
<p>If the data you need is fundamentally different from data currently used, you may also need to add a collation function to <code class="docutils literal notranslate"><span class="pre">mlreco/iotools/collates.py</span></code></p>
</div>
<div class="section" id="include-your-model">
<h3>2 - Include your model<a class="headerlink" href="#include-your-model" title="Permalink to this headline">¶</a></h3>
<p>You should put your model in a new file in the <code class="docutils literal notranslate"><span class="pre">mlreco/models</span></code> folder.</p>
<p>Add your model to the dictionary in <code class="docutils literal notranslate"><span class="pre">mlreco/models/factories.py</span></code> so it can be found by the configuration parsers.</p>
<p>At this point, you should be able to train your model using a configuration file.</p>
</div>
<div class="section" id="documentation-todo">
<h3>3 - Documentation TODO<a class="headerlink" href="#documentation-todo" title="Permalink to this headline">¶</a></h3>
<p>Brief descriptions of analysis and output formatters</p>
</div>
</div>
</div>
<div class="section" id="iotools">
<h1>Iotools<a class="headerlink" href="#iotools" title="Permalink to this headline">¶</a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">iotools</span></code> section contains all information regarding how to parse data stored in <code class="docutils literal notranslate"><span class="pre">.root</span></code> files. An example configuration option for <code class="docutils literal notranslate"><span class="pre">iotool</span></code> is given below.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">iotool</span><span class="p">:</span>
  <span class="nt">batch_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">16</span>
  <span class="nt">shuffle</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">False</span>
  <span class="nt">num_workers</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4</span>
  <span class="nt">collate_fn</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CollateSparse</span>
  <span class="nt">sampler</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">RandomSequenceSampler</span>
  <span class="nt">dataset</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">LArCVDataset</span>
    <span class="nt">data_keys</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/gpfs/slac/staas/fs1/g/neutrino/kterao/data/mpvmpr_2020_01_v04/train.root</span>
    <span class="nt">limit_num_files</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="nt">schema</span><span class="p">:</span>
      <span class="nt">input_data</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">parse_cluster3d_full</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">cluster3d_pcluster_highE</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">particle_corrected</span>
      <span class="nt">cluster_label</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">parse_cluster3d_full</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">cluster3d_pcluster_highE</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">particle_corrected</span>
      <span class="nt">graph</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">parse_particle_graph</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">particle_corrected</span>
      <span class="nt">segment_label</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">parse_sparse3d_scn</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sparse3d_pcluster_semantics</span>
</pre></div>
</div>
<p>We list the definitions of each variable as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">batch_size</span></code>: batch size for gradient descent.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shuffle</span></code>: option to shuffle sample each instance of the dataset.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_workers</span></code>:</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collate_fn</span></code>: Collate function used in <code class="docutils literal notranslate"><span class="pre">torch.DataLoader</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sampler</span></code>:</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dataset</span></code>:</p></li>
</ul>
<div class="section" id="schema">
<h2>1. Schema<a class="headerlink" href="#schema" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id1">
<h2>2.<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id2">
<h2><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
</div>
</div>
<div class="section" id="models">
<h1>Models<a class="headerlink" href="#models" title="Permalink to this headline">¶</a></h1>
<p>Model building blocks</p>
<p>Model chains</p>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "DeepLearnPhysics/lartpc_mlreco3d_tutorials",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Code/lartpc_mlreco3d"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By SLAC Neutrino Group<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>