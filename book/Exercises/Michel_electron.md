---
jupytext:
  cell_metadata_filter: -all
  formats: md:myst
  text_representation:
    extension: .md
    format_name: myst
    format_version: 0.13
    jupytext_version: 1.10.3
kernelspec:
  display_name: Python 3
  language: python
  name: python3
---

# Exercise 1: Finding Michel electrons

Michel electrons come out of a muon decay. They are electrons, so they look like
an electromagnetic shower coming out of a long muon track. 

Stages of the chain required: UResNet only!

```{note} TODO
Write solutions.
```

## Motivation
Michel electrons are used in LArTPC
experiments as "candles": we understand their energy spectrum very well, so they
can be used to calibrate the detector and to compare the quality of different detectors.
Michel electrons spectrum is one of the first "tokens" that an experiment will show to
prove that the detector is running and we can successfully reconstruct the data.
Since their energy is in a range up to ~50MeV, they are also representative of the 
detector response to electromagnetic particles generated by neutrino activity.

```{figure} https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQsezzzPeMfyra-aaqqooRh-IAVN61XbgDDuQ&usqp=CAU
Example of Michel electron spectrum
```

## What are we looking for?


```{figure} ./electron_stopping_power.png
---
figclass: margin
---
Energy loss per unit distance (MeV/cm) for electrons traveling in liquid argon. From {cite}`MicrobooneMichel`.
```

The primary Michel electron that comes out of the muon decay-at-rest can lose energy
either through ionization (collision stopping power), or through the production of 
radiative photons via Bremsstrahlung (radiative stopping power). Beyond a certain energy,
the radiative stopping power is greater than the collision stopping power. If the radiative
photons have enough energy, they can pair-produce, i.e. turn into an electron-positron pair.
They, in turn, can produce new radiative photons, and so on. They can also undergo Compton scattering.
A cascade of electrons and photons (electromagnetic shower) happens.



Ionization produces track-like energy depositions, whereas the photons can travel
some distance before converting into a secondary electron. Hence Michel electrons have 
two clear topological features: a primary ionization, which is track-like at the end
of the muon track, and some scattered energy deposits much further away which come from 
these radiative photons.

```{figure} ./michel.png
---
height: 300px
---
Example of Michel electron topology
```

In this exercise, we are only concerned with finding the primary ionization of the Michel electron. 
We will purposefully ignore for now the radiative photons.

## Setup
If needed, you can edit the path to `lartpc_mlreco3d` library and to the data folder.
```{code-cell}
import os
SOFTWARE_DIR = '%s/lartpc_mlreco3d' % os.environ.get('HOME') 
DATA_DIR = '../data'
```

The usual imports and setting the right `PYTHON_PATH`...  click if you need to see them.
```{code-cell}
:tags: [hide-cell]

import sys, os
# set software directory
sys.path.insert(0, SOFTWARE_DIR)
```

```{code-cell}
:tags: [hide-cell]

import numpy as np
import yaml
import torch
import plotly
import plotly.graph_objs as go
from plotly.offline import iplot, init_notebook_mode
init_notebook_mode(connected=False)

from mlreco.visualization import scatter_points, plotly_layout3d
from mlreco.visualization.gnn import scatter_clusters, network_topology, network_schematic
from mlreco.utils.ppn import uresnet_ppn_type_point_selector
from mlreco.utils.cluster.dense_cluster import fit_predict_np, gaussian_kernel
from mlreco.main_funcs import process_config, prepare
from mlreco.utils.gnn.cluster import get_cluster_label
from mlreco.utils.deghosting import adapt_labels_numpy as adapt_labels
from mlreco.visualization.gnn import network_topology

from larcv import larcv
```

The configuration is loaded from the file [inference.cfg](../data/inference.cfg).
```{code-cell}
:tags: [hide-output]

cfg=yaml.load(open('%s/inference.cfg' % DATA_DIR, 'r').read().replace('DATA_DIR', DATA_DIR),Loader=yaml.Loader)
# pre-process configuration (checks + certain non-specified default settings)
process_config(cfg)
# prepare function configures necessary "handlers"
hs=prepare(cfg)
```

The output is hidden because it reprints the entire (lengthy) configuration. Feel 
free to take a look if you are curious!

Finally we run the chain for 1 iteration:
```{code-cell}
# Call forward to run the net, store the output in "res"
data, output = hs.trainer.forward(hs.data_io_iter)
```
Now we can play with `data` and `output` to visualize what we are interested in. Feel free to change the
entry index if you want to look at a different entry!
```{code-cell}
entry = 0
```
Let us grab the interesting quantities:
```{code-cell}
clust_label = data['cluster_label'][entry]
input_data = data['input_data'][entry]
segment_label = data['segment_label'][entry][:, -1]

ghost_mask = output['ghost'][entry].argmax(axis=1) == 0
segment_pred = output['segmentation'][entry].argmax(axis=1)
```

## Step 1: extract the semantic segmentation predictions.
Get the UResNet semantic segmentation predictions from the chain output.

```{code-cell}
:tags: [hide-cell]

some solution code here
```

## Step 2: identify muons and electrons particles.
Use the predictions that you retrieved and a simple clustering algorithm
such as DBSCAN to isolate muons and electron particle instances (groups
of voxels).

```{code-cell}
:tags: [hide-cell]

some solution code here
```

## Step 3: make sure the electron is touching the end of the muon track.
There can be many ways to do this check.

```{code-cell}
:tags: [hide-cell]

some solution code here
```

## Step 4: make a plot!
Let's use the voxel count as a substitute for the reconstructed energy. This 
approximation is fairly accurate for shower-like particles. Make a histogram with
Michel electron candidates voxel counts. 

```{code-cell}
:tags: [hide-cell]

some solution code here
```

## Other readings
Michel Electron Reconstruction Using
Cosmic-Ray Data from the MicroBooNE LArTPC
https://lss.fnal.gov/archive/2017/pub/fermilab-pub-17-090-nd.pdf


```{bibliography}
:style: alpha
```